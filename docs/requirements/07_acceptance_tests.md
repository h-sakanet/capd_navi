# 07. 受入テスト

## 1. テスト方針
- 判定優先度は「安全制御」「記録完全性」「セッション整合」「CSV整合性」です。
- 1件エラーで取り込み中止の原則を検証します。
- 同一セッションの単一書き込み保証を重点検証します。

## 2. 必須シナリオ

### 2.1 CSV取込（Mac）
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-CSV-001 | 正常取込 | 正常CSV v3 + 画像 | 取込実行 | 成功しテンプレート登録 |
| AT-CSV-002 | 重複検出 | `step_id`重複CSV | 取込実行 | エラーで中止 |
| AT-CSV-003 | 直列整合 | `next_step_id`不整合CSV | 取込実行 | エラーで中止 |
| AT-CSV-004 | 画像存在 | 画像不足CSV | 取込実行 | エラーで中止 |
| AT-CSV-005 | 警告検知 | `xx分`含有CSV | 取込実行 | 取込成功 + 警告表示 |
| AT-CSV-006 | `alarm_id` 必須 | `timer_event=end` かつ `timer_segment=dwell/drain` で `alarm_id` 空 | 取込実行 | エラーで中止 |
| AT-CSV-007 | `alarm_id` 重複 | 通知対象行で同一 `alarm_id` が重複 | 取込実行 | エラーで中止 |
| AT-CSV-008 | 対象外 `alarm_id` 警告 | 通知対象外行に `alarm_id` 設定 | 取込実行 | 取込成功 + 警告表示 |

### 2.2 進行制御
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-FLOW-001 | 必須チェック | 必須チェックありステップ | 未チェックで次へ | 遷移不可 |
| AT-FLOW-002 | 記録ゲート | `record_event`ステップ | 未保存で次へ | 遷移不可 |
| AT-FLOW-003 | 直列遷移 | 通常ステップ | 次へ | `next_step_id`へ遷移 |
| AT-FLOW-004 | 同時実行制限 | 実行中セッションあり | 新規開始 | `409` |
| AT-FLOW-005 | 戻る遷移 | セッション進行中 | 戻る押下 | 直前ステップへ表示遷移 |
| AT-FLOW-006 | 左優先実行 | 右側スロット開始前に左側未実施あり | 右側スロット開始 | `409 LEFT_SLOT_NOT_COMPLETED` |
| AT-FLOW-007 | 推奨時刻順序 | スロット登録済み | 右側が左側以下の時刻で保存 | `422 SLOT_TIME_ORDER_INVALID` |
| AT-FLOW-008 | 予期せぬ離脱再開 | セッション進行中にアプリ離脱 | ホームで実施中スロットを選択 | 進行位置を保持して再開する |
| AT-FLOW-009 | 非常中断 | セッション進行中 | `•••`→中断→確認 | セッションが `aborted` で終了する |

### 2.3 同期/競合
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-SYNC-001 | 単一書き込み | Mac開始セッションあり | iPhoneから更新API | 拒否される |
| AT-SYNC-002 | 遅延同期 | セッション完了済み | 別端末ホーム表示 | 完了記録が表示される |
| AT-SYNC-003 | 競合編集 | 同一recordを別端末編集 | 古いrevisionで保存 | `409` |
| AT-SYNC-004 | スロット同期 | 端末Aで当日スロット更新 | 端末Bで同期実行 | `dailyProcedurePlans` 差分でスロット表示が更新される |
| AT-SYNC-005 | 進行中閲覧禁止 | 端末Aで `active` セッション進行中 | 端末Bで `GET /sessions/{id}` | `403 ACTIVE_SESSION_VIEW_FORBIDDEN` |
| AT-SYNC-006 | active非同期 | 端末Aで `active` セッション進行中 | 端末Bで `GET /sync/changes` | `sessions[]` に `active` が含まれない |

### 2.4 タイマー/アラーム
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-TIMER-001 | start記録 | `timer_event=start`ステップ | 到達 | 自動時刻記録 |
| AT-TIMER-002 | end記録 | `timer_event=end`ステップ | 到達 | 自動時刻記録 |
| AT-TIMER-003 | 戻る時の再発火抑止 | `timer_event/record_event/通知ジョブ生成` 対象ステップ到達済み | 戻る→再表示 | タイマー再記録・記録イベント重複保存・再通知が発生しない |
| AT-TIMER-004 | 貯留終了ジョブ生成 | `timer_segment=dwell` のCSV定義あり | セッション開始〜該当ステップ到達 | 貯留終了タイマー通知ジョブがCSVどおり生成される |
| AT-TIMER-005 | 廃液終了ジョブ生成 | `timer_segment=drain` のCSV定義あり | セッション開始〜該当ステップ到達 | 廃液終了タイマー通知ジョブがCSVどおり生成される |
| AT-ALARM-001 | T0通知 | タイマー終了時刻到達 | 待機 | Macローカル通知（音+バナー）とアプリ内未確認アラートが表示される |
| AT-ALARM-002 | 見逃し対策 | 通知未許可/不達 | タイマー終了時刻到達 | アプリ内強調アラーム表示で運用継続できる |
| AT-ALARM-003 | 確認継続 | 未確認アラート表示中 | 確認せず待機 | ACKまで表示が継続する |
| AT-ALARM-004 | 段階再通知間隔 | タイマー終了後未確認 | T+2分/T+5分以降経過 | `T+2分` で再通知、`T+5分以降` は3分間隔で再通知される |
| AT-ALARM-005 | iPhone補助エスカレーション | iPhone Push購読済み | タイマー終了後2分未確認 | iPhoneへ補助通知が1回送信される |
| AT-ALARM-006 | ACK停止 | Mac/iPhone通知中 | ACK実行 | Mac/iPhone通知ジョブが停止し `acked_at` が記録される |
| AT-ALARM-007 | 離席高リスク表示 | iPhone補助なし + 離席想定 | タイマー運用開始 | 見逃し高リスク警告が表示される |
| AT-ALARM-008 | Push購読無効時挙動 | iPhone Push購読が無効 | タイマー終了後未確認 | iPhone補助通知は送信されず、Mac再通知 + アプリ内警告で継続する |
| AT-ALARM-009 | missed遷移永続化 | タイマー終了後30分未ACK | 状態確認 | 対象 `alarm_id` が `status=missed` で永続化される |
| AT-ALARM-010 | pendingAlarm選定 | 未ACKの複数 `alarmDispatches` あり | `GET /sessions/{id}` | `due_at` 最古（同着は `alarm_id` 昇順）の1件が `pendingAlarm` に選定される |
| AT-ALARM-011 | 見逃し状態遷移 | タイマー終了後30分未ACK | 画面表示/復帰 | `missed`（見逃し状態）が表示され、警告が継続する |

### 2.5 記録
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-REC-001 | 見た目分類 | `drain_appearance` | 分類選択し保存 | 保存成功 |
| AT-REC-002 | 写真任意 | `drain_appearance` | 写真なし保存 | 保存成功 |
| AT-REC-003 | 単位整合 | `drain_weight_g` | gで入力保存 | 保存成功 |
| AT-REC-004 | 必須入力 | `session_summary` | 必須欠落で保存 | 保存失敗 |
| AT-REC-005 | 履歴編集 | 記録済みセッション | 記録一覧から編集保存 | 更新値が反映 |
| AT-REC-006 | 最初セッション必須 | 当日最初に完了するセッション | 血圧/体重/脈拍/体温/出口部状態欠落で完了 | 完了拒否（必須不足） |
| AT-REC-007 | 最後セッション必須 | 当日最後に完了するセッション | 飲水量/尿量/排便回数欠落で完了 | 完了拒否（必須不足） |
| AT-REC-008 | 同日1セッション | 当日1件のみ実施 | 最初/最後必須群の一部欠落で完了 | 完了拒否（両群要求） |
| AT-REC-009 | 出口部状態語彙 | `session_summary` 入力時 | enum外の値を送信 | `422` で拒否 |
| AT-REC-010 | summaryScope算出 | `session_summary` 保存 | `payload.summaryScope` 未指定または不正値で保存 | サーバーが `first_of_day/last_of_day/both` を再計算して保存する |

### 2.6 写真容量/バックアップ/エクスポート
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-PHOTO-001 | 容量上限 | 写真総量 > 1GB | 写真保存処理 | 古い順削除で0.95GB以下 |
| AT-BACKUP-001 | 日次バックアップ | スケジュール有効 | 1日経過 | バックアップ1件作成 |
| AT-EXPORT-001 | 手動ZIP | セッション記録あり | エクスポート実行 | ZIPダウンロード可 |

### 2.7 プラットフォーム/スリープ
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-PLAT-001 | iPhone利用 | iPhone Safari/PWA | ホームからセッション開始 | Webアプリとして利用可 |
| AT-PLAT-002 | Mac利用 | Macネイティブシェル | ホームを開く | 利用可 |
| AT-NATIVE-001 | Mac通知 | 通知許可済み | タイマー終了時刻到達 | OS通知（音+バナー）が発火 |
| AT-SLEEP-001 | 状態表示 | セッション中 | ステップ表示 | スリープ抑止状態表示 |
| AT-SLEEP-002 | フォールバック | 抑止失敗環境 | セッション開始 | 注意表示とガイダンス |
| AT-SLEEP-003 | Mac抑止 | Macネイティブ | セッション実行 | `active` 表示 |

### 2.8 記録一覧画面
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-HISTORY-001 | 導線分離 | ホーム表示中 | 記録一覧を押下 | 記録一覧画面へ遷移 |
| AT-HISTORY-002 | 一覧表示 | 記録1件以上 | 記録一覧を開く | CAPDノート準拠項目で一覧表示される |
| AT-HISTORY-003 | 編集導線 | 記録一覧表示中 | 編集押下 | 編集導線へ遷移 |
| AT-HISTORY-004 | 写真遷移 | 写真ありレコード | 写真リンク押下 | 写真詳細画面へ遷移 |
| AT-HISTORY-005 | 総除水量計算 | 排液量/前回注液量データあり | 一覧表示 | 総除水量(自動)が差し引き計算値で表示される |
| AT-HISTORY-006 | record列マッピング | `record_exchange_no` が混在 | 一覧表示 | `drain_weight_g`/`bag_weight_g`/`drain_appearance` が指定列(#1〜#5)に表示される |
| AT-HISTORY-007 | timer列マッピング | `timer_exchange_no` が混在 | 一覧表示 | `dwell`/`drain` の `start-end` が指定列(#1〜#5)に表示される |
| AT-HISTORY-008 | 初回除水量 | 交換#1に前回注液量なし | 一覧表示 | 交換#1の除水量は `未計算` 表示になる |

### 2.9 UIスパイク
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-UI-HOME-001 | Home A表示確認 | プレビュー画面あり | 画面確認 | A案確定仕様と一致する |
| AT-UI-HOME-002 | Home A初期状態 | Home A初回表示 | 画面確認 | #1〜#4が未登録(`+`)で表示 |
| AT-UI-HOME-003 | Home A設定導線 | Home A表示中 | `+`押下→設定モーダル保存 | スロットに手技/推奨実施と `•••` メニューが表示 |
| AT-UI-HOME-004 | Home A開始導線 | Home Aで手技設定済み | カード本体タップ | 「手技の開始」確認ダイアログが表示される |
| AT-UI-HOME-005 | Home A確認モーダル | Home Aで手技設定済み | `•••`→確認押下 | 閲覧専用モーダル表示（記録/タイマー/アラーム設定なし） |
| AT-UI-HOME-006 | Home A編集導線 | Home Aで手技設定済み | `•••`→編集押下 | 手技設定モーダルが既存値で再表示 |
| AT-UI-HOME-007 | Home Aタップ棲み分け | Home Aで `•••` メニュー表示中 | `•••` / メニューを操作 | カード開始タップが誤発火しない |
| AT-UI-HOME-008 | Home当日ノート表示 | Home A表示中 | 画面確認 | 当日分のみCAPD記録ノート互換表が5列(#1〜#5)で表示される |
| AT-UI-HOME-009 | 交換除水量計算 | Home Aで当日ノート表示 | 画面確認 | 交換#1は `未計算`、交換#2以降は `排液量-前回注液量` で表示される |
| AT-UI-HOME-010 | CSVタイトル表示 | Home Aで当日ノート表示 | 画面確認 | 透析液濃度欄にCSVタイトル（例: レギニュール1.5）が表示される |
| AT-UI-HOME-011 | タイマー表示 | Home Aで当日ノート表示 | 画面確認 | 貯留時間/排液時間が `timer start-end` 形式で表示される |
| AT-UI-HOME-012 | Home A開始確定 | Home Aで開始確認ダイアログ表示中 | 開始押下 | Session Aへ遷移 |
| AT-UI-HOME-013 | Home A実施済み制御 | Home Aでステータス=実施済みカードあり | カード本体タップ | 開始操作が無効化される |
| AT-UI-HOME-014 | Home A見出し構成 | Home A表示中 | 画面確認 | パネル見出しは日付のみ表示し、当日ノートは同一パネル内に表示される |
| AT-UI-HOME-015 | Home A実施中表示 | セッション進行中のスロットあり | 画面確認 | スロット表示が `実施中` になる |
| AT-UI-HOME-016 | Home A再開導線 | `実施中` スロットあり | カード本体タップ | 再開確認後に同一セッションへ戻る |
| AT-UI-HOME-017 | 中断バッジ非表示 | 中断後にホームへ戻る | 画面確認 | `前回中断あり` の表示は出ない |
| AT-UI-HOME-018 | 外部アラーム注記 | Home A表示中 | 画面確認 | 「手技開始通知は外部アラーム運用」の注記が表示される |
| AT-UI-SESSION-001 | Session A表示確認 | プレビュー画面あり | 画面確認 | A案確定仕様と一致する |
| AT-UI-LAYOUT-001 | レスポンシブ | iPhone/Macで表示 | セッション画面表示 | iPhone=1カラム, Mac=2カラム |
| AT-UI-LAYOUT-002 | 画像比率 | セッション画面 | 画像表示 | 正方形(1:1)で表示 |
| AT-UI-SESSION-002 | 通し番号表示 | Session A表示中 | 画面確認 | タイトル先頭に `#通し番号` が表示される |
| AT-UI-SESSION-003 | 状態バッジ表示 | Session A表示中 | 画面確認 | 状態は Compact Badge（MynaUI icon + 色）で表示される |
| AT-UI-SESSION-004 | 遷移ボタン配置 | Session A表示中 | 画面確認 | 戻る/次へがiPhone/Macとも横並び同幅で表示される |
| AT-UI-SESSION-005 | カルーセル遷移 | Session A表示中 | 次へ/戻る/Enter(次へ) | メインパネルが左右スライドで遷移する |
| AT-UI-SESSION-006 | 非常中断動線 | Session A表示中 | 右上 `•••` を開く | `セッションを中断（非常用）` が表示される |
| AT-UI-SESSION-007 | 非常中断後復帰 | Session Aで中断確定 | 画面遷移確認 | ホームへ戻り、該当スロットが `未実施` に戻る |

### 2.10 ホームスロット永続化
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-SLOT-001 | 初期化 | 対象日のスロット未作成 | `GET /daily-procedure-slots` | `empty` 4件で返却される |
| AT-SLOT-002 | 競合検知 | revision更新済み | 古い `baseRevision` で `PUT` | `409 SLOT_PLAN_REVISION_MISMATCH` |
| AT-SLOT-003 | 編集ロック | 対象日に active セッションあり | `PUT` / `DELETE` | `409 ACTIVE_SESSION_EXISTS` |
| AT-SLOT-004 | 完了ロック | `completed` スロットあり | `PUT` / `DELETE` | `409 SLOT_ALREADY_COMPLETED` |
| AT-SLOT-005 | 中断後再開 | 対象スロットの最新セッションが `aborted` | 同じ `slotNo` で `POST /sessions` | 開始可能（`planned` 維持） |
| AT-SLOT-006 | 完了反映 | スロット紐づきセッション完了 | `GET /daily-procedure-slots` | 当該 `slotNo` が `completed` で返る |

### 2.11 開始時スナップショット
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-SNAPSHOT-001 | 作成必須 | 有効な手技テンプレートあり | `POST /sessions` | `sessions` と `session_protocol_snapshots` が同時作成される |
| AT-SNAPSHOT-002 | 原子性 | スナップショット書き込みを意図的に失敗させる | `POST /sessions` | `500 SESSION_SNAPSHOT_CREATE_FAILED`、`sessions` 行が残らない |
| AT-SNAPSHOT-003 | 固定再現 | セッション開始後に同 `protocolId` の新版を取り込み | `GET /sessions/{id}` | 開始時スナップショットの手順/画像キーで表示される |
| AT-SNAPSHOT-004 | 欠落検知 | `session_protocol_snapshots` 行を欠落させる | `GET /sessions/{id}` | `409 SESSION_SNAPSHOT_INTEGRITY_ERROR` |
| AT-SNAPSHOT-005 | 改ざん検知 | `snapshot_hash` と `steps_json` を不整合化 | `GET /sessions/{id}` | `409 SESSION_SNAPSHOT_INTEGRITY_ERROR` |

### 2.12 運用（通知テスト）
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-OPS-001 | 毎日30秒テスト | 当日最初のタイマー運用前 | テスト通知実行 | 30秒テスト通知が実施でき、失敗時は当日「iPhone補助なし」扱いへ切替できる |

## 3. 境界値テスト
- 必須チェック0件ステップで遷移可能か
- 最終ステップのみ `next_step_id` 空欄許容か
- セル内改行を含む `必須チェック` が正しく分割されるか
- 同一セッション内で複数 `alarm_id` が独立して再通知管理されるか
- 段階再通知（T+2分、T+5分以降3分間隔）がタイマーずれなく動作するか
- 通知権限未許可時でもアプリ内アラーム表示で運用継続できるか

## 4. 回帰テスト観点
- CSVパーサ更新で既存v3が読めなくならないこと
- 記録モーダル変更時に進行ブロック条件が崩れないこと
- 版管理変更時にスナップショット再現性が維持されること
- 同期ロジック変更時に単一書き込み制約が崩れないこと
- スリープ抑止/アラームUI変更後も既存遷移が崩れないこと
