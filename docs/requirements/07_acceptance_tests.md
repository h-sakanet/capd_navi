# 07. 受入テスト

## 1. テスト方針
- 判定優先度は「安全制御」「記録完全性」「同期整合」「復旧性」です。
- 1件エラーで取り込み中止の原則を検証します。
- ローカル正本とクラウド共有の最終的整合が成立することを重点検証します。

## 1.1 実行参照
- 動線起点は `09_user_journeys.md` の `JRN-*` を使用します。
- 画面遷移と操作は `10_screen_transition_and_actions.md` の `SCR-*` / `ACT-*` を使用します。
- 入力項目と表示順は `11_form_contracts.md` の `FC-*` を使用します。

## 2. 必須シナリオ

### 2.1 CSV取込（Mac）
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-CSV-001 | 正常取込 | 正常CSV v3 + 画像 | 取込実行 | 成功しテンプレート登録 |
| AT-CSV-002 | 重複検出 | `step_id`重複CSV | 取込実行 | エラーで中止 |
| AT-CSV-003 | 直列整合 | `next_step_id`不整合CSV | 取込実行 | エラーで中止 |
| AT-CSV-004 | 画像存在 | 画像不足CSV | 取込実行 | エラーで中止 |
| AT-CSV-005 | 警告検知 | `xx分`含有CSV | 取込実行 | 取込成功 + 警告表示 |

### 2.2 進行制御
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-FLOW-001 | 必須チェック | 必須チェックありステップ | 未チェックで次へ | 遷移不可 |
| AT-FLOW-002 | 記録ゲート | `record_event`ステップ | 未保存で次へ | 遷移不可 |
| AT-FLOW-003 | 直列遷移 | 通常ステップ | 次へ | `next_step_id`へ遷移 |
| AT-FLOW-004 | 端末内同時実行制限 | 同一端末に実行中セッションあり | 新規開始 | 開始不可 |
| AT-FLOW-005 | 左優先実行 | 右側スロット開始前に左側未実施あり | 右側スロット開始 | 開始不可 |
| AT-FLOW-006 | 予期せぬ離脱再開 | セッション進行中にアプリ離脱 | ホームで実施中スロットを選択 | 進行位置を保持して再開 |
| AT-FLOW-007 | 非常中断 | セッション進行中 | `•••`→中断→確認 | セッションが `aborted` で終了 |

### 2.3 同期（最重要）
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-SYNC-001 | 起動時pull復元 | 端末Aで未同期データあり | 端末Bを起動 | 未同期日付バンドルが復元される |
| AT-SYNC-002 | 完了時push反映 | 端末Aでセッション完了 | 同期実行後に端末Bを復帰 | 完了記録が端末Bへ反映される |
| AT-SYNC-003 | LWW内部適用 | 同一エンティティを2端末で更新 | 双方同期 | LWW比較キーで勝者が一意に決まり、データ整合が保たれる |
| AT-SYNC-004 | 同日同スロット競合 | 2端末が同日同スロットを更新 | 双方同期 | 重複セッションは保持され、スロットはLWW勝者に収束 |
| AT-SYNC-005 | 手動同期消し込み | outboxにpendingあり | 手動同期実行 | outboxが空になる |
| AT-SYNC-006 | 復帰時失敗導線 | ネットワーク失敗を注入 | アプリ復帰で同期実行 | 同期失敗バナー + 再試行導線が表示される |

### 2.4 復旧
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-RECOVERY-001 | DB消失復元 | iOS側IndexedDBを消去 | アプリ起動 | Blobsからフル復元できる |
| AT-RECOVERY-002 | クラウド欠損再シード | 端末ローカルに記録あり、Blobsの `index.json/days/photos` を欠損させる | 手動同期を実行 | `cloudState=missing` を検知し `syncMode=full_reseed` で再シード、ローカルデータを失わずクラウドが再構築される |
| AT-RECOVERY-003 | 再シード失敗時保全 | 端末ローカルに記録あり、`syncMode=full_reseed` を失敗注入 | 手動同期を実行 | `lastSyncStatus=failed` と再試行導線が表示され、ローカル記録とoutbox pendingが保持される |

### 2.5 タイマー/アラーム
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-ALARM-001 | T0通知 | タイマー終了時刻到達 | 待機 | Macローカル通知（音+バナー） + アプリ内アラート |
| AT-ALARM-002 | 段階再通知 | タイマー終了後未確認 | T+2分/T+5分以降経過 | 仕様どおり再通知 |
| AT-ALARM-003 | ACK停止 | Mac/iPhone通知中 | ACK実行 | 通知停止 + `acked_at` 記録 |
| AT-ALARM-004 | 見逃し状態 | タイマー終了後30分未ACK | 状態確認 | `status=missed` 永続化 + 警告継続 |

### 2.6 写真容量/バックアップ
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-PHOTO-001 | 容量上限 | 写真総量 > 1GB | 写真保存処理 | 古い順削除で0.95GB以下 |
| AT-BACKUP-001 | 日次バックアップ | スケジュール有効 | 31日分経過 | 30日保持ポリシーで古い世代が削除 |

### 2.7 API境界・保存形式
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-API-001 | 公開API最小化 | APIルーティング一覧取得可能 | ルート一覧確認 | 公開APIは `POST /sync/push` と `POST /sync/pull` のみ |
| AT-API-002 | エクスポート廃止 | 画面導線あり | UI確認 | 手動エクスポート導線が表示されない |
| AT-API-003 | CSVローカル完結 | MacでCSV取込操作可能 | 取込実行 | `POST /protocols/import-package` を呼ばずローカル処理で完了 |
| AT-API-004 | 非暗号化キー | 同期済みデータあり | Blobキー確認 | `index.json`, `days/*.json`, `photos/*.jpg` で保存され `.enc` がない |

### 2.8 プラットフォーム/スリープ
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-PLAT-001 | iPhone利用 | iPhone Safari/PWA | ホームからセッション開始 | Webアプリとして利用可 |
| AT-PLAT-002 | Mac利用 | Macネイティブシェル | ホームを開く | 利用可 |
| AT-SLEEP-001 | 状態表示 | セッション中 | ステップ表示 | スリープ抑止状態表示 |

### 2.9 UIスパイク
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-UI-HOME-001 | Home表示確認 | プレビュー画面あり | 画面確認 | A案確定仕様と一致 |
| AT-UI-HOME-002 | Home初期状態 | Home初回表示 | 画面確認 | #1〜#4が未登録(`+`) |
| AT-UI-SESSION-001 | Session表示確認 | プレビュー画面あり | 画面確認 | A案確定仕様と一致 |

### 2.10 出口部写真（`exit_site_photo`）
| ID | 観点 | 前提 | 操作 | 期待結果 |
|---|---|---|---|---|
| AT-EXIT-001 | 表示前提（未完了） | 当日 `first_of_day`/`both` 未完了 | ホーム全体サマリ/記録詳細を表示 | 出口部写真の操作行が表示されない |
| AT-EXIT-002 | 表示前提（完了後） | 当日 `first_of_day` 完了 | iPhoneホーム全体サマリを表示 | `登録` ボタンが表示される |
| AT-EXIT-003 | 両導線一貫性 | 対象レコードあり | iPhoneホームとiPhone記録詳細を表示 | 両導線で同じ写真状態を表示する |
| AT-EXIT-004 | 端末制約 | 同一日の記録あり | Macホーム/詳細を表示 | 閲覧のみで登録/変更/削除が表示されない |
| AT-EXIT-005 | 状態遷移（登録後） | 未登録状態 | iPhoneで写真登録 | 表示が `変更/削除` に切り替わる |
| AT-EXIT-006 | 1枚固定置換 | 既に1枚登録済み | iPhoneで `変更` を実行 | 写真が置換され、複数枚保持されない |
| AT-EXIT-007 | 削除挙動 | 登録済み | iPhoneで `削除` を実行 | `exit_site_photo=null` が保存され、未登録表示へ戻る |
| AT-EXIT-008 | 保存後表示 | 写真登録済み | 記録詳細を再表示 | 保存済み写真が表示できる |
| AT-EXIT-009 | 同期反映 | 端末Aで写真登録済み | 同期後に端末Bで表示 | 写真状態が端末Bへ反映される |
| AT-EXIT-010 | 部分更新競合 | Macで他サマリ項目更新、iPhoneで写真更新 | 双方同期 | `payload.exit_site_photo` のみ更新され、他項目が失われない |
| AT-EXIT-011 | `both` 対応 | 1日1回運用で `summaryScope=both` | iPhoneで写真登録 | `first_of_day` と同等に登録できる |
| AT-EXIT-012 | 容量制御共通化 | 写真総量が上限超過 | 追加写真を保存 | `drain` と同一ポリシーで古い順削除が実行される |

## 3. 境界値テスト
- 必須チェック0件ステップで遷移可能か
- 最終ステップのみ `next_step_id` 空欄許容か
- セル内改行を含む `必須チェック` が正しく分割されるか
- 同一セッション内で複数 `alarm_id` が独立して再通知管理されるか
- 段階再通知（T+2分、T+5分以降3分間隔）がタイマーずれなく動作するか
- tombstone と upsert が同時到着した場合にLWWで一意決定できるか

## 4. 回帰テスト観点
- CSVパーサ更新で既存v3が読めなくならないこと
- 記録モーダル変更時に進行ブロック条件が崩れないこと
- 版管理変更時にスナップショット再現性が維持されること
- 同期ロジック変更時にLWW規則が崩れないこと
- API最小化方針（`sync/push`, `sync/pull` のみ）が維持されること
