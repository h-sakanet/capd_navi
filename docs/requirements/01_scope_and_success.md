# 01. スコープと成功基準

## 1. プロダクト目的
CAPD手技における操作ミス、手順スキップ、記録漏れを防止し、安全性と記録品質を維持できるアプリを提供します。

## 2. 対象ユーザー
- 主対象: 本人（単一利用者）
- 初期対象外: 家族代理入力、医療者向け共有ポータル

## 3. 解決する課題
- 手技ステップが多く、順序逸脱や確認漏れが発生しやすい
- 待機工程で時間経過を忘れやすい
- 記録（液量、見た目、バイタル）が抜け落ちやすい
- 端末が複数でも、手技実行と記録閲覧の整合を保ちたい

## 4. スコープ内（v1）
- 共通Webアプリ（iPhone/Mac） + Macネイティブシェルで提供
- Macネイティブシェル（WKWebView）でOS通知、画面スリープ抑止、CSV/画像取り込み
- 複数手技テンプレートの一覧表示と選択開始
- ホームから独立した「記録一覧」画面で履歴確認/編集
- CSV v3取り込みによる手技テンプレート登録（Macのみ）
- 1セッション=1手技テンプレート実行
- 完全シリアル遷移のステップ実行
- 重要工程の遷移ブロック
- `record_event` による記録モーダルの強制入力
- `timer_event(start/end)` の自動時刻記録
- `timer_event=end`（`dwell`/`drain`）を対象にしたタイマー終了通知
- 未確認時の段階再通知（T+2分、T+5分以降3分間隔）
- 待機アラーム時のアプリ内強調表示（ACKまで継続）
- 通知チャネルは `Mac主チャネル固定 + iPhone補助`
- 手技開始通知は本アプリ対象外（外部アラーム運用）
- 毎日30秒テスト通知による運用品質確認
- 手技中の画面スリープ抑止状態表示（Macはネイティブ制御、iPhoneはベストエフォート）
- セッション開始時の手順スナップショット保存
- 同時実行セッション1件制限
- 予期せぬ離脱後のセッション再開（実施中スロットから再開）
- セッション画面の非常用中断（明示中断）
- セッション完了後の遅延同期（ホーム表示時/復帰時/120秒間隔）
- 写真保存上限1GB、超過時古い順削除
- 日次自動バックアップ（保持30日）
- 手動ZIPエクスポート
- Web UIのコンポーネント基盤として shadcn/ui を採用

## 5. スコープ外（v1）
- 手順分岐（条件分岐、ループ、並列）
- iOSネイティブアプリ（App Store配布）
- 医療者共有ポータル、医療者連携通知
- 異常時の連絡ボタン、家族通知、救急導線
- 日英多言語対応
- 常設医療免責文表示

## 6. 非機能前提
- 端末: iPhone / MacBook
- 主運用端末: Macネイティブシェル
- iPhone運用: 代替端末（確認/記録/履歴閲覧）
- 通信: オンライン必須
- データ保存: クラウド正本 + 端末最小キャッシュ
- 認証: アプリ内認証なし（公開URL運用）
- 文言: 日本語のみ

## 7. 成功基準（受入レベル）
- 正常CSVを取り込み、手技テンプレートが利用可能になる
- CSVと画像の不整合は1件でも取り込み中止になる
- 必須チェック未完了時、次ステップへ遷移できない
- 記録必須イベント未入力時、次ステップへ遷移できない
- 同一セッションは作成端末でのみ更新/閲覧（進行中）できる
- セッション完了後、別端末で記録を閲覧できる
- 記録一覧がホームとは別画面で表示される
- ホーム4スロットが日付単位で永続化され、左->右の推奨時刻順が維持される
- 左側未実施スロットがある場合、右側スロットを開始できない
- セッション進行中はホームで `実施中` 表示となり、スロット選択で再開できる
- 非常中断後にホームへ戻り、対象スロットが `未実施` 表示へ戻る
- `POST /sessions` 成功時に、開始時スナップショットが必ず作成される（保存失敗時は開始失敗）
- セッション再開時は開始時スナップショットを使用し、現行テンプレート版への自動差し替えが発生しない
- 手技中にスリープ抑止状態が表示され、抑止不可時は注意表示される
- 待機アラーム時にMac通知 + アプリ内強調表示で気づける
- 未確認時に段階再通知（T+2分、T+5分以降3分間隔）が実行される
- ACK時に通知ジョブが停止し `acked_at` が記録される
- 写真容量超過時に古い写真が自動削除される
- 日次バックアップが継続され、手動ZIPエクスポートが実行できる

## 8. KPI候補（実装後計測）
- 手順逸脱率（ブロック発生件数/セッション）
- 記録欠損率（必須記録の欠損件数/セッション）
- CSV取り込み成功率
- アラーム見逃し率（確認遅延件数/アラーム件数）
- 同期反映遅延（完了から別端末表示までの時間）
