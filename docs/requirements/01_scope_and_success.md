# 01. スコープと成功基準

## 1. プロダクト目的
CAPD手技における操作ミス、手順スキップ、記録漏れを防止し、安全性と記録品質を維持できるアプリを提供します。

## 2. 対象ユーザー
- 主対象: 本人（単一利用者）
- 初期対象外: 家族代理入力、医療者向け共有ポータル

## 3. 解決する課題
- 手技ステップが多く、順序逸脱や確認漏れが発生しやすい
- 待機工程で時間経過を忘れやすい
- 記録（液量、見た目、バイタル）が抜け落ちやすい
- 端末が複数でも、手技実行と記録閲覧の整合を保ちたい

## 4. スコープ内（v1）
- 共通Webアプリ（iPhone/Mac） + Macネイティブシェルで提供
- Macネイティブシェル（WKWebView）でOS通知、画面スリープ抑止、CSV/画像取り込み
- 複数手技テンプレートの一覧表示と選択開始
- ホームから独立した「記録一覧」画面で履歴確認/編集
- CSV v3取り込みによる手技テンプレート登録（Macのみ）
- 1セッション=1手技テンプレート実行
- 完全シリアル遷移のステップ実行
- 重要工程の遷移ブロック
- `record_event` による記録モーダルの強制入力
- `timer_event(start/end)` の自動時刻記録
- `timer_event=end`（`dwell`/`drain`）を対象にしたタイマー終了通知
- 未確認時の段階再通知（T+2分、T+5分以降3分間隔）
- 待機アラーム時のアプリ内強調表示（ACKまで継続）
- 通知チャネルは `Mac主チャネル固定 + iPhone補助`
- 手技開始通知は本アプリ対象外（外部アラーム運用）
- 手動30秒テスト通知（必要時）による運用品質確認
- 手技中の画面スリープ抑止状態表示（Macはネイティブ制御、iPhoneはベストエフォート）
- セッション開始時の手順スナップショット保存
- 同一端末内の同時実行セッション1件制限
- 予期せぬ離脱後のセッション再開（実施中スロットから再開）
- セッション画面の非常用中断（明示中断）
- 同期契機（起動/復帰/完了/手動）での遅延同期
- 競合時のLWW自動解決（内部適用のみ）
- `first_of_day`（1日1回運用時は `both`）完了後に出口部写真登録導線を表示
- 出口部写真の登録/変更/削除はiPhoneのみ、Macは閲覧のみ
- 写真保存上限1GB、超過時古い順削除
- 日次スナップショットバックアップ（保持30日）
- 同期API最小構成（`POST /sync/push`, `POST /sync/pull`）
- 同期データは非暗号化で保存（HTTPS通信前提）
- Web UIのコンポーネント基盤として shadcn/ui を採用

## 5. スコープ外（v1）
- 手順分岐（条件分岐、ループ、並列）
- iOSネイティブアプリ（App Store配布）
- 医療者共有ポータル、医療者連携通知
- 異常時の連絡ボタン、家族通知、救急導線
- 日英多言語対応
- 常設医療免責文表示
- リアルタイム双方向同期（同時編集ロック）

## 6. 非機能前提
- 端末: iPhone / MacBook
- 主運用端末: Macネイティブシェル
- iPhone運用: 代替端末（確認/記録/履歴閲覧）
- 通信: オンライン推奨（通信断時はローカル継続し復帰後同期）
- データ保存: ローカル正本 + クラウド共有/バックアップ
- 認証: アプリ内認証なし（公開URL運用）
- 公開API: `POST /sync/push` と `POST /sync/pull` のみ
- 文言: 日本語のみ

## 7. 成功基準（受入レベル）
- 正常CSVを取り込み、手技テンプレートが利用可能になる
- CSVと画像の不整合は1件でも取り込み中止になる
- 必須チェック未完了時、次ステップへ遷移できない
- 記録必須イベント未入力時、次ステップへ遷移できない
- セッション完了後、別端末で記録を閲覧できる
- 記録一覧がホームとは別画面で表示される
- ホーム4スロットが日付単位で永続化され、左->右の推奨時刻順が維持される
- 左側未実施スロットがある場合、右側スロットを開始できない
- セッション進行中はホームで `実施中` 表示となり、スロット選択で再開できる
- 非常中断後にホームへ戻り、対象スロットが `未実施` 表示へ戻る
- セッション再開時は開始時スナップショットを使用し、現行テンプレート版への自動差し替えが発生しない
- 同期後に競合が発生した場合、LWWで内部的に一意解決され、データ不整合が残らない
- iOSでローカルDB消失後、クラウドからフル復元できる
- Blobs欠損時に `cloudState=missing` を検知し、ローカル正本から全量再シードでクラウド再構築できる
- `first_of_day`（または `both`）完了後、iPhoneホーム全体サマリとiPhone記録詳細で出口部写真の登録導線が表示される
- 出口部写真は iPhone で登録/変更/削除でき、Macでは閲覧のみになる
- 出口部写真の変更/削除が同期され、他サマリ項目を失わず端末間で一致する
- 手技中にスリープ抑止状態が表示され、抑止不可時は注意表示される
- 待機アラーム時にMac通知 + アプリ内強調表示で気づける
- 未確認時に段階再通知（T+2分、T+5分以降3分間隔）が実行される
- ACK時に通知ジョブが停止し `acked_at` が記録される
- 写真容量超過時に古い写真が自動削除される
- 日次バックアップが継続され、30日保持ポリシーが維持される

## 8. 計測方針（v1）
- v1では件数ベースKPIを保持しません。運用状態は「直近同期状態（成功/失敗）」の現在値表示のみとします。
