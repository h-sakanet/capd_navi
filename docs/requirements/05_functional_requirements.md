# 05. 機能要件

## 1. ホーム機能
- FR-001: 複数手技テンプレート一覧を表示します。
- FR-002: テンプレートごとに名称、版、有効開始日を表示します。
- FR-003: 選択した1手技でセッションを開始します。
- FR-004: 手技開始通知は本アプリ対象外とし、Mac/iPhoneの時計アプリ等の外部アラームで運用します。
- FR-004A: ホームに「手技開始通知は外部アラーム運用」の注記を表示します。
- FR-005: ホームには手技開始情報に加え、当日分のみCAPD記録ノート互換表を表示します（過去分は一覧画面で表示）。
- FR-005A: ホームAの先頭見出しは日付のみを表示し、手技スロットと当日ノート表は同一パネル内に配置します。
- FR-006: ホームから「記録一覧」画面へ遷移できる導線を提供します。
- FR-007: ホームAスパイクでは、1日あたり4件の手技スロットを横並びで表示します。
- FR-008: 手技スロットの初期状態は「`+` のみ表示」とし、`+` 押下で手技設定モーダル（CSV選択、推奨実施時間）を開きます。
- FR-009: 手技設定後は「カード本体タップ=開始」とし、開始前に「手技の開始」確認ダイアログを表示します。
- FR-009A: 右上 `•••` メニューから「確認/編集」を開きます。確認モーダルは内容確認のみ（記録入力、タイマー設定、アラーム設定なし）とします。
- FR-009B: 手技スロットの表示状態は `未登録(+)` / `未実施` / `実施中` / `実施済み` とします。`実施済み` のカード本体タップは無効化します。
- FR-009C: スロット登録時は、右隣スロットほど推奨実施時間が遅くなるように検証します（左から右へ厳密昇順、同時刻不可）。
- FR-009D: 右側スロットの開始時は、左側スロットがすべて `実施済み` であることを必須条件にします（未登録/未実施が1件でもあれば開始不可）。
- FR-009E: 4スロット設定は `dateLocal` 単位でサーバー永続化し、`revision` による競合検知を行います。
- FR-009F: `実施済み` スロットは編集/削除不可とします。対象日に進行中セッションがある間は全スロット編集を禁止します。
- FR-009G: `実施中` スロットをタップした場合は新規開始せず、進行中セッションを再開します。

## 2. 記録一覧/編集機能
- FR-010: 記録一覧画面で日々の手技記録を一覧表示します。
- FR-011: 記録一覧画面で詳細表示と編集導線を提供します。
- FR-012: 記録編集は `baseRevision` で競合検知します。
- FR-013: 記録一覧にはCAPDノート準拠項目（貯留時間、透析液濃度、排液量、注液量、排液時間、排液の確認、除水量、尿量、飲水量、体重、排便、血圧、出口部状態、備考）を表示します。
- FR-014: 写真はサムネイル固定表示ではなく、リンク押下で写真詳細画面へ遷移します。
- FR-015: 交換ごとの除水量と1日の総除水量は、`排液量 - 前回注液量` の差し引きで自動計算表示します。
- FR-015A: 初回交換（#1列）は前回注液量が存在しないため、除水量は `未計算` 表示とします。
- FR-015B: 1日の総除水量は、計算可能な交換（#2列以降で前回注液量が存在する交換）のみを合算します。
- FR-015C: `opening_infuse_weight_g`（初期注液量）は v1 では空欄許容とし、除水量計算に使用しません。
- FR-016: 当日ノート表と記録一覧の交換列は `#1〜#5` の5列固定とし、列位置は `*_exchange_no` で決定します。
- FR-017: 透析液濃度欄は、取り込みCSVのタイトル（例: `レギニュール1.5`）を表示します。
- FR-018: `record_event` の値は `record_exchange_no` で列マッピングし、`drain_weight_g` は排液量、`bag_weight_g` は注液量、`drain_appearance` は排液の確認に表示します。
- FR-019: `timer_event` の値は `timer_exchange_no` で列マッピングし、`timer_segment=dwell` の `start/end` は貯留時間、`timer_segment=drain` の `start/end` は排液時間に表示します。

## 3. CSV取り込み機能（Mac限定）
- FR-020: MacネイティブシェルでCSV+画像ディレクトリを選択できます。
- FR-021: CSV v3フォーマットのみ受け付けます。
- FR-022: 検証エラー1件以上で取り込みを中止します。
- FR-023: 警告は取り込み結果画面で一覧表示します。
- FR-024: 画像相対パスを `protocol.csv` ディレクトリ基準で解決します。

## 4. セッション進行機能
- FR-030: 現在ステップのフェーズと状態を常時表示し、タイトルは通し番号付き（例: `#21 お腹のチューブのクランプを開ける`）で表示します。
- FR-031: 必須チェック未完了時に次ステップ遷移を禁止します。
- FR-032: `record_event` 未完了時に次ステップ遷移を禁止します。
- FR-033: `next_step_id` に従い完全シリアルで遷移します。
- FR-034: 最終ステップ完了時にセッション完了状態へ遷移します。
- FR-035: セッション開始端末のみ進行更新できます。
- FR-036: 同時実行セッションを1件に制限します。
- FR-037: セッション画面の手順画像は1:1正方形領域で表示します。
- FR-038: セッション画面は iPhoneで1カラム、Macで2カラム表示に切り替えます。
- FR-039: セッション画面に「戻る」操作を提供し、直前ステップへ表示遷移できます。
- FR-039A: セッション画面の「戻る」と「次へ」は、iPhone/Macの双方で横並び・同幅で表示します。
- FR-039B: 「次へ」「戻る」押下時、および Enter キーによる次ステップ遷移時は、メインパネルを左右スライドで遷移表示します。
- FR-039C: セッション画面のカルーセルは、左右ナビゲーションボタンを表示しません。
- FR-039D: セッション画面右上 `•••` メニューに `セッションを中断（非常用）` を配置します。
- FR-039E: `セッションを中断（非常用）` は確認ダイアログを経て実行し、中断後はホームへ戻します。
- FR-039F: 明示中断時はセッションを `aborted` で終了し、対応スロットの表示状態を `未実施` へ戻します。
- FR-039G: ホームのスロットには `前回中断あり` の表示を出しません（履歴は記録一覧で確認）。

## 5. 記録機能
- FR-040: `drain_appearance` 入力モーダルを提供します。
- FR-041: 見た目分類は `透明/やや混濁/混濁/血性/その他` を提供します。
- FR-042: 廃液写真は任意入力です。
- FR-043: `drain_weight_g` と `bag_weight_g` を g単位で保存します。
- FR-044: `session_summary` で以下を収集します。
  - 最初に完了したセッション（同一日内の `completedAt` 最小）で必須: 血圧上、血圧下、体重、脈拍、体温、出口部状態
  - 最後に完了したセッション（同一日内の `completedAt` 最大）で必須: 飲水量、尿量、排便回数
  - 任意: 症状メモ、備考
- FR-044A: 同一日に1セッションのみ完了した場合は、最初/最後の両条件を同時適用し、必須項目をすべて満たす必要があります。
- FR-044B: 出口部状態は複数選択チェックボックスで入力し、語彙は `正常/赤み/痛み/はれ/かさぶた/じゅくじゅく/出血/膿` とします。追加の自由記述は備考欄に入力します。

## 6. タイマー/アラーム機能
- FR-050: `timer_event` と `timer_segment` から、CSV設定に従ってタイマー終了通知ジョブを生成します。
- FR-050A: 通知対象は `timer_event=end` の終了イベントとし、`timer_segment=dwell/drain` を同一ルールで扱います。
- FR-050B: 同一セッション内の通知ジョブは `alarm_id` 単位で独立管理します。
- FR-050C: 通知ジョブは最低限 `alarm_id / segment / due_at / acked_at / attempt_no / status` を保持します。
- FR-051: 終了時刻 `T0` で Mac ローカル通知（音+バナー）を発火し、同時にアプリ内未確認アラートを固定表示します。
- FR-052: 未確認時は段階再通知を行います。
- FR-052A: 再通知間隔は `T+2分`（iPhone補助通知1回 + Mac再通知）、`T+5分以降`（3分間隔でMac+iPhone再通知）とします。
- FR-052B: 段階再通知の対象は「貯留終了（`dwell`）」「廃液終了（`drain`）」に限定します。
- FR-053: ACK時は Mac/iPhone の通知ジョブをすべて停止し、`acked_at` を記録します。
- FR-054: アプリ内アラートは ACK まで継続表示し、通知再送も ACK まで継続します。
- FR-055: 通知チャネルは `Mac主チャネル固定 + iPhone補助` とします。
- FR-055A: iPhone未利用かつ離席想定時は「見逃し高リスク」警告を必須表示します。
- FR-055B: iPhone補助通知の利用可否は Push購読状態（登録/無効化）で管理します。
- FR-056: 「戻る」操作、過去ステップ再表示、アプリ再開、通信リトライでは、`timer_event(start/end)`・`record_event`・通知ジョブ生成を再発火しません。
- FR-057: 毎日最初のタイマー運用前に30秒テスト通知を実施し、失敗時は当日を「iPhone補助なし（Mac主導）」として扱います。
- FR-058: `T+30分` 未確認時は「見逃し状態」を表示し、次回画面表示時も警告を継続します。

## 7. 異常判定機能
- FR-060: 見た目分類ベースの簡易判定を行います。
- FR-061: 異常時は警告表示のみ行います。
- FR-062: 連絡ボタン等の導線はv1対象外とします。

## 8. 版管理機能
- FR-070: 新版取り込み後、テンプレート版として保存します。
- FR-071: セッション開始時は `sessions` 作成と同一トランザクションで `SessionProtocolSnapshot` を保存し、スナップショット保存失敗時は開始自体を失敗させます（`SESSION_SNAPSHOT_CREATE_FAILED`）。
- FR-072: スナップショットには `sourceProtocol(meta)`、step定義本文（通し番号/タイトル/文言/必須チェック/timer/alarm/record）、画像 `assetKey`、`assetManifest`、`snapshotHash` を含めます。
- FR-073: セッション表示/再開時は開始時スナップショットを常に優先し、現行テンプレート版へフォールバックしません。
- FR-074: スナップショット欠落またはハッシュ不整合は `SESSION_SNAPSHOT_INTEGRITY_ERROR` として扱い、セッション表示を停止します。
- FR-075: テンプレート新版の取り込み後も、開始済みセッションの表示内容は開始時スナップショットから変化しません。

## 9. 同期機能
- FR-080: 同一セッションは作成端末のみ更新可能とします。
- FR-080A: 進行中セッション（`status=active`）の閲覧/再開は作成端末のみ許可します（別端末閲覧は対象外）。
- FR-081: セッション完了後、別端末は遅延同期で閲覧可能にします。
- FR-082: 同期タイミングはホーム表示時・復帰時・120秒間隔とします。

## 10. 写真/バックアップ/エクスポート機能
- FR-090: 写真はJPEG再圧縮して保存します（長辺1600px/quality 85）。
- FR-091: 写真総量は1GB上限とし、超過時は古い順削除します。
- FR-092: 日次バックアップを1日1回実行し、30日保持します。
- FR-093: 手動ZIPエクスポートを提供します（セッションJSON + 写真）。

## 11. セキュリティ/接続要件
- FR-100: アプリ内認証は行いません（公開URL運用）。
- FR-101: オンライン接続を必須とします。
- FR-102: 記録データの正本はクラウド保存とします。
- FR-103: iOSネイティブアプリ配布はv1対象外とします。

## 12. プラットフォーム要件
- FR-109: 提供形態は `Web本体 + Mac薄型ネイティブシェル（WKWebView）` で固定します。
- FR-110: MacネイティブシェルはOS通知連携を提供します。
- FR-111: Macネイティブシェルは画面スリープ抑止を提供します。
- FR-112: iPhoneはPWA通知対応時のみOS通知を利用します。
- FR-113: スリープ抑止が未対応/失敗の場合、注意表示と対処ガイダンスを表示します。
- FR-114: Web UIコンポーネント基盤は `shadcn/ui` を採用します。
- FR-115: Web UIのアイコンセットは `MynaUI Icons`（`@mynaui/icons-react`）を採用します。

## 13. 非機能要件
- NFR-001: CSV取り込み結果はエラー/警告箇所を特定できること。
- NFR-002: セッション再開時に最後の進行位置を復元できること。
- NFR-003: 画面文言は日本語で統一すること。
- NFR-004: アラーム表示は通常ステップ表示より高い視認性を持つこと。
- NFR-005: 同期失敗時に再試行導線を提供すること。
