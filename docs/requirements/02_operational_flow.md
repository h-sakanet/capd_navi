# 02. 運用フロー

## 1. 日次運用の基本
- 主端末は Mac ネイティブシェル（WKWebView）を利用します。
- iPhone は代替端末として、手技確認・記録・履歴閲覧に利用します。
- 同時実行セッションは1件のみとし、開始端末のみ更新可能です。
- 手技開始通知は本アプリ対象外とし、外部アラーム（時計アプリ等）で運用します。
- 記録一覧はホームに表示せず、専用の「記録一覧」画面で確認・編集します。
- ホームの4スロットは、左から右へ推奨実施時間が厳密昇順になるように登録します。
- 右側スロットは、左側スロットがすべて実施済みになるまで開始できません。
- ホーム表示時は `GET /daily-procedure-slots?date=...` で当日スロットを取得し、未作成日は空スロットで初期化します。
- `実施中` スロットはタップで再開し、新規セッション開始は行いません。
- 30秒テスト通知は、通知設定変更時・OS更新後・通知不調時に手動実施します。
- 手動30秒テストが失敗した日は iPhone補助を無効扱いとし、Mac主導運用へ切替します。

## 2. セッション実行フロー
1. ホームで当日スロットを参照し、対象スロットからセッション開始
2. サーバーで `sessions` と `session_protocol_snapshots` を同一トランザクション保存し、`executionToken` を開始端末へ返却
3. ステップ表示（フェーズ/状態を常時表示）
4. スリープ抑止を試行し状態表示（Mac: ネイティブ、iPhone: ベストエフォート）
5. 必須チェック完了まで遷移不可
6. `record_event` 完了まで遷移不可
7. `POST /sessions/{id}/steps/{stepId}/enter` でステップ到達を確定し、`timer_event` を自動記録
8. `timer_event=end` かつ `timer_segment=dwell/drain` の到達時、通知ジョブ（`alarm_id`, `segment`, `due_at`）を生成
9. 終了時刻 `T0` でMac通知（音+バナー）を発火し、アプリ内未確認アラートを固定表示
10. 未確認時は `T+2分` で iPhone補助通知 + Mac再通知、`T+5分以降` は3分間隔でMac+iPhone再通知
11. ACK時に通知ジョブを停止し `acked_at` を記録
12. `next_step_id` に従って次ステップへ遷移
13. 最終ステップでセッション完了
14. 最終ステップ完了処理（`POST /sessions/{id}/steps/{stepId}/complete`）内で、保存済み `session_summary` の必須項目を判定（最初完了セッション: 血圧/体重/脈拍/体温/出口部状態、最後完了セッション: 飲水量/尿量/排便回数）
15. 完了後に別端末へ遅延同期され、閲覧可能になる

## 2.1 ホームスロット管理フロー
1. `GET /daily-procedure-slots?date=...` で当日4スロットを取得
2. `+` から `PUT /daily-procedure-slots/{slotNo}` で登録/更新（`baseRevision` 必須）
3. `DELETE /daily-procedure-slots/{slotNo}` で未登録へ戻す（`baseRevision` 必須）
4. `completed` スロットは編集不可
5. 対象日に active セッションが存在する間はスロット編集不可

## 2.2 離脱/再開/中断
- 予期せぬ離脱（アプリ終了、端末クラッシュ、通信断）時はセッションを `active` のまま保持します。
- 再起動後はホームで `実施中` スロットを選択し、対応 `activeSessionId` を `GET /sessions/{id}` で復元して再開します。
- セッション画面の `•••` から `セッションを中断（非常用）` を実行した場合のみ `aborted` へ遷移します。
- `aborted` 実行後はホームへ戻し、該当スロット表示は `未実施` へ戻します（同一スロットで再開始可能）。

## 2.3 スナップショット運用
- スナップショット固定範囲は、開始時点の実行必要情報全体です（step定義本文、必須チェック、timer/alarm/record指示、画像 `assetKey`、`assetManifest`）。
- `POST /sessions` ではスナップショット保存失敗時にロールバックし、セッションを開始しません（`SESSION_SNAPSHOT_CREATE_FAILED`）。
- `GET /sessions/{id}` は開始時スナップショットのみを参照し、テンプレート現行版への差し替えを行いません。
- スナップショット欠落またはハッシュ不整合を検出した場合は `SESSION_SNAPSHOT_INTEGRITY_ERROR` を返し、表示再開を停止します。

## 3. 業務フロー図（共通）
```mermaid
flowchart TD
  A[外部アラームで手技開始時刻を通知] --> B[ホーム表示]
  B --> B2[記録一覧画面へ遷移]
  B2 --> B3[記録詳細/編集]
  B --> C[手技テンプレート選択]
  C --> D[POST /sessions]
  D --> E[sessionId + executionToken受領]
  E --> W[スリープ抑止試行 + 状態表示]
  W --> F[ステップ表示]
  F --> G{必須チェック完了?}
  G -- いいえ --> F
  G -- はい --> H{record_event完了?}
  H -- いいえ --> F
  H -- はい --> I[POST /sessions/{id}/steps/{stepId}/enter]
  I --> I2[timer記録]
  I2 --> J{alarm対象?}
  J -- はい --> K[Mac通知 + アプリ内強調]
  K --> K2{ACK済み?}
  K2 -- いいえ --> K3[T+2分: iPhone補助 + Mac再通知]
  K3 --> K4[T+5分以降: 3分間隔で再通知]
  K2 -- はい --> L
  K4 --> K2
  J -- いいえ --> L
  L --> L2{最終ステップ?}
  L2 -- いいえ --> F
  L2 -- はい --> M[セッション完了]
  M --> N[別端末は遅延同期で閲覧]
  N --> B2
```

## 4. 同期フロー
- 同期対象は「日次スロット計画」「完了済みセッション」「履歴編集結果」「テンプレート更新」です。
- 同期タイミングはホーム表示時・アプリ復帰時・120秒間隔です。
- 同期APIは `GET /sync/changes?sinceCursor=...` を使用します。
- セッション進行中の更新/閲覧は開始端末のみ許可します（別端末閲覧は対象外）。
- 別端末での `sessionId` 解決は完了/中断セッションのみを対象とし、active の `sessionId` は同期しません。

## 5. CSV取り込みフロー（Macのみ）
1. Macネイティブで取り込み対象ディレクトリを選択
2. `protocol.csv` と画像群を検証
3. `POST /protocols/import-package` で一括アップロード
4. サーバーでCSV検証・画像保存・正規化JSON生成
5. 成功時にテンプレート一覧を更新

## 6. 記録運用
- `drain_appearance`: 見た目分類 + 任意メモ + 任意写真
- `drain_weight_g`: 廃液重量（g）
- `bag_weight_g`: 透析液重量（g）
- `session_summary`: 最初完了セッションで血圧上/下、体重、脈拍、体温、出口部状態（複数選択）を必須化
- `session_summary`: 最後完了セッションで飲水量、尿量、排便回数を必須化
- `session_summary`: 症状メモ、備考は任意

## 7. 通知/アラーム運用
- 通知対象は `timer_event=end` のうち `timer_segment=dwell/drain` のみです。
- Macを主チャネルとし、終了時刻 `T0` でOSローカル通知を発火します。
- 未確認時は `T+2分` で iPhone補助通知（1回） + Mac再通知、`T+5分以降` は3分間隔でMac+iPhoneを再通知します。
- iPhoneはPWA Push購読が有効な場合のみ補助通知を受信します。
- 通知未許可/未対応時でも、アプリ内強調アラームをACKまで継続表示します。
- ACK時に通知ジョブを停止し `acked_at` を保存します。

## 8. バックアップ/エクスポート運用
- 日次バックアップ: 毎日1回、DB論理ダンプとメタ情報を保存（保持30日）
- 手動エクスポート: ユーザー操作でZIP生成（セッションJSON + 写真）

## 9. 異常判定運用（v1）
- 見た目分類ベースの簡易判定のみ
- 異常分類時は警告表示のみ
- 連絡導線はv1対象外
