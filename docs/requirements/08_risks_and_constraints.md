# 08. リスクと制約

## 1. リスク一覧

| ID | リスク | 影響 | 対策 |
|---|---|---|---|
| R-001 | CSV文言の未確定値が残る | 手技誤解、待機時間誤り | 取り込み警告 + 公開前レビュー工程 |
| R-002 | 画像ファイル不整合 | 手順理解低下 | 取込時ファイル存在チェック |
| R-003 | 記録入力負荷が高い | 入力離脱 | 必須/任意を明確化しモーダル最適化 |
| R-004 | オンライン依存 | 通信不安定時に利用不可 | 接続状態UIと再試行導線 |
| R-005 | 公開URL漏えい | 第三者閲覧リスク | URL管理手順の運用徹底、必要時に再発行 |
| R-006 | iPhone通知制約 | 補助通知が不達になり見逃し率上昇 | Mac主チャネル固定 + 段階再通知 + 必要時30秒テスト |
| R-007 | スリープ抑止の端末依存 | 待機後復帰手間でUX低下 | Macネイティブ抑止 + 失敗時ガイダンス |
| R-008 | 写真容量上限超過 | 過去記録の画像欠落 | 古い順削除と容量使用量表示 |
| R-009 | バックアップ失敗の見逃し | 復旧不能リスク | 日次ジョブ監視と失敗アラート |
| R-010 | 日次スロット編集競合 | 登録順序崩れ、誤開始 | `baseRevision` 競合検知 + 左右時刻順/左優先開始バリデーション |
| R-011 | 非常中断の誤操作 | 手技継続中断による運用混乱 | `•••` 内配置 + 確認ダイアログ + 監査ログ記録 |
| R-012 | スナップショット欠落/改ざん | 再開時に誤手順表示または再開不能 | 開始時の原子的保存 + `snapshot_hash` 整合検証 + 異常時は再開停止 |
| R-013 | アラーム再送重複 | 通知多重で判断混乱 | `(sessionId, alarmId)` 冪等化 + `alarmId` 上書き登録 + 受入試験で再送抑止確認 |
| R-014 | 必要時テスト未実施 | iPhone補助不達を事前検知できない | 通知設定変更時/OS更新後/通知不調時に30秒テストを実施する運用を定義 |
| R-015 | Mac離席かつiPhoneなし | タイマー終了見逃しリスクが高い | 高リスク警告を常時表示し、Mac主導運用を徹底 |

## 2. 制約
- 利用端末はiPhoneとMacBookを前提とする
- 提供形態は共通Web + Macネイティブシェル
- iOSネイティブアプリ配布は対象外（デベロッパー登録なし）
- 手順遷移は完全シリアルのみ（分岐不可）
- CSVフォーマットはv3のみ
- CSV取り込みはMacのみ
- オフライン運用は対象外（オンライン必須）
- アプリ内認証は対象外（公開URL運用）
- 医療免責文の常設表示は対象外
- 通知対象は「貯留終了」「廃液終了」のタイマー終了通知のみ
- 通知チャネルは `Mac主チャネル固定 + iPhone補助` とする
- iPhone通知音の常時保証はしない（OS設定依存）

## 3. データ品質上の留意点
現状ベースCSVで以下プレースホルダが確認されています。

- `(これはなんだろう)`
- `xx分程度待つ`
- `03-xxxx-xxxx`

本番適用前に確定文言へ置換が必要です。

## 4. 4シナリオ別運用（通知）
| シナリオ | 主に効く通知 | 想定動作 | 注意点 |
|---|---|---|---|
| 寝ている | iPhone補助 | Mac通知後、未確認時にiPhoneへエスカレーション | iPhone設定依存があるため、通知設定変更時/OS更新後/通知不調時は30秒テストが必要 |
| 別アプリ閲覧中 | Mac主 | OS通知で気づき、未確認時にiPhone補助が追従 | Focus/消音設定で検知率が低下する場合がある |
| Mac離席（iPhoneあり） | iPhone補助 | iPhone通知で回収しACK可能 | Push未許可時は回収率が低下する |
| Mac離席（iPhoneなし） | Macのみ | Mac再通知を継続 | 見逃し高リスクのため警告表示を必須化する |

## 5. 将来拡張（優先順）
1. 異常時の行動導線（連絡ボタン、メモ共有）
2. 医療者共有出力（PDF/CSV）
3. 家族見守り・代理記録
4. 閾値ベースの異常判定拡張
5. 多言語対応

## 6. 実装時の前提維持ポイント
- `record_event` の追加はCSV列拡張で吸収できる設計にします。
- 手技テンプレートは複数同居を前提とし、単一手技前提のハードコードを禁止します。
- セッション再現性を守るため、開始時スナップショット保持を削除しません。
- セッション更新APIは `X-Execution-Token` 必須を維持します。
- 写真容量監視（1GB上限）と縮退削除処理を削除しません。
- 手技開始通知は本アプリに実装せず、外部アラーム運用を維持します。
- 手動30秒テスト手順（必要時実施）を削除しません。

## 7. 非対象（明確化）
- 本アプリでの手技開始通知
- iPhone通知音の常時保証
- Web通知の独自通知音指定
