# 08. リスクと制約

> 移行メモ（2026-02-11）: 本文の正本は `docs/spec/45_nfr/risks-and-constraints.md` / `docs/spec/45_nfr/non-functional.md` / `docs/spec/45_nfr/observability.md` へ再構成済みです。  
> 本書は旧体系参照用として残置し、更新は `docs/spec` 側を優先します。


## 1. リスク一覧

| ID | リスク | 影響 | 対策 |
|---|---|---|---|
| R-001 | CSV文言の未確定値が残る | 手技誤解、待機時間誤り | 取り込み警告 + 公開前レビュー工程 |
| R-002 | 画像ファイル不整合 | 手順理解低下 | 取込時ファイル存在チェック |
| R-003 | 記録入力負荷が高い | 入力離脱 | 必須/任意を明確化しモーダル最適化 |
| R-004 | 同期失敗の継続 | 端末間反映遅延 | 手動同期導線 + 復帰時再試行 + 失敗バナー |
| R-005 | 公開URL漏えい | 第三者閲覧リスク | URL管理手順の運用徹底、必要時に再発行 |
| R-006 | iPhone通知制約 | 補助通知が不達になり見逃し率上昇 | Mac主チャネル固定 + 段階再通知 + 必要時30秒テスト |
| R-007 | スリープ抑止の端末依存 | 待機後復帰手間でUX低下 | Macネイティブ抑止 + 失敗時ガイダンス |
| R-008 | 写真容量上限超過 | 過去記録の画像欠落 | 古い順削除と容量使用量表示 |
| R-009 | バックアップ失敗の見逃し | 復旧不能リスク | 日次ジョブ監視と失敗アラート |
| R-010 | 日次スロット編集競合 | 登録順序崩れ、誤開始 | LWW + 左右時刻順/左優先開始バリデーション |
| R-011 | 非常中断の誤操作 | 手技継続中断による運用混乱 | `•••` 内配置 + 確認ダイアログ + 監査ログ記録 |
| R-012 | スナップショット欠落/改ざん | 再開時に誤手順表示または再開不能 | 開始時の原子的保存 + `snapshot_hash` 整合検証 + 異常時は再開停止 |
| R-013 | アラーム再送重複 | 通知多重で判断混乱 | `(sessionId, alarmId)` 冪等化 + 受入試験で再送抑止確認 |
| R-014 | 必要時テスト未実施 | iPhone補助不達を事前検知できない | 通知設定変更時/OS更新後/通知不調時に30秒テストを実施する運用を定義 |
| R-015 | Mac離席かつiPhoneなし | タイマー終了見逃しリスクが高い | 高リスク警告を常時表示し、Mac主導運用を徹底 |
| R-016 | iOS IndexedDB消失 | ローカル履歴消失、運用停止 | `storage.persist()` 要求 + 起動時復元 + 復旧ガイダンス |
| R-017 | 非暗号化同期データ | URL漏えい時の閲覧リスクが増加 | HTTPS前提 + URL管理徹底 + 漏えい時のURL再発行 |
| R-018 | 競合可視化の縮小 | 上書き発生に気づきにくい | 更新前手動同期を推奨し、同時編集を運用で回避 |
| R-019 | 同時編集上書き | 片方の更新内容が失われる | LWW内部適用 + 更新前同期ルールで発生率を抑制 |
| R-020 | `first_of_day`/`both` 未完了 | 出口部写真が登録できず記録漏れが発生 | ホーム全体サマリに未表示理由を明示し、対象サマリ入力完了導線を表示 |
| R-021 | iPhone依存の写真登録 | iPhone不在時に出口部写真登録が遅延 | Macには閲覧専用表示を固定し、iPhoneでの後追い登録タスクを同期後バナーで再通知 |
| R-022 | 監査メトリクス廃止 | 原因分析に時間がかかる | 障害時は同期状態表示と再現手順ログの手動記録で補完 |
| R-023 | Blobs誤削除/欠損 | 端末追加時にクラウド復元不能 | `cloudState=missing` 検知時にローカル全量 `full_reseed` を実行しクラウド再構築 |

## 2. 制約
- 利用端末はiPhoneとMacBookを前提とする
- 提供形態は共通Web + Macネイティブシェル
- iOSネイティブアプリ配布は対象外（デベロッパー登録なし）
- 手順遷移は完全シリアルのみ（分岐不可）
- CSVフォーマットはv3のみ
- CSV取り込みはMacのみ
- アプリ内認証は対象外（公開URL運用）
- 同期データ暗号化は v1 で実施しない（HTTPS通信前提）
- 医療免責文の常設表示は対象外
- 通知対象は「貯留終了」「廃液終了」のタイマー終了通知のみ
- 通知チャネルは `Mac主チャネル固定 + iPhone補助` とする
- iPhone通知音の常時保証はしない（OS設定依存）
- リアルタイム同期は対象外（最終的整合）
- 手動エクスポート機能は v1 対象外
- 出口部写真の登録/変更/削除はiPhoneのみ許可し、Macは閲覧のみとする
- 出口部写真の操作表示は当日 `summaryScope=first_of_day` または `summaryScope=both` の完了後に限定する

## 3. データ品質上の留意点
現状ベースCSVで以下プレースホルダが確認されています。

- `(これはなんだろう)`
- `xx分程度待つ`
- `03-xxxx-xxxx`

本番適用前に確定文言へ置換が必要です。

## 4. 4シナリオ別運用（通知）
| シナリオ | 主に効く通知 | 想定動作 | 注意点 |
|---|---|---|---|
| 寝ている | iPhone補助 | Mac通知後、未確認時にiPhoneへエスカレーション | iPhone設定依存があるため、通知設定変更時/OS更新後/通知不調時は30秒テストが必要 |
| 別アプリ閲覧中 | Mac主 | OS通知で気づき、未確認時にiPhone補助が追従 | Focus/消音設定で検知率が低下する場合がある |
| Mac離席（iPhoneあり） | iPhone補助 | iPhone通知で回収しACK可能 | Push未許可時は回収率が低下する |
| Mac離席（iPhoneなし） | Macのみ | Mac再通知を継続 | 見逃し高リスクのため警告表示を必須化する |

## 5. 将来拡張（優先順）
1. 異常時の行動導線（連絡ボタン、メモ共有）
2. 医療者共有出力（PDF/CSV）
3. 家族見守り・代理記録
4. 閾値ベースの異常判定拡張
5. 多言語対応

## 6. 実装時の前提維持ポイント
- `record_event` の追加はCSV列拡張で吸収できる設計にします。
- 手技テンプレートは複数同居を前提とし、単一手技前提のハードコードを禁止します。
- セッション再現性を守るため、開始時スナップショット保持を削除しません。
- LWW比較キー（`updatedAt`, `updatedByDeviceId`, `mutationId`）を変更しません。
- outbox未送信データの消失を許容しません。
- 写真容量監視（1GB上限）と縮退削除処理を削除しません。
- 公開API最小構成（`POST /sync/push`, `POST /sync/pull`）を崩しません。
- 更新前に手動同期する運用ルールを削除しません。
- 手技開始通知は本アプリに実装せず、外部アラーム運用を維持します。
- 手動30秒テスト手順（必要時実施）を削除しません。

## 7. 非対象（明確化）
- 本アプリでの手技開始通知
- iPhone通知音の常時保証
- Web通知の独自通知音指定
- 同時編集時の手動マージUI
