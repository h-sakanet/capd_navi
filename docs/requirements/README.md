# CAPD支援アプリ 要件定義ドキュメント

## 1. 目的
本ディレクトリは、実装エージェントが設計判断を追加せずに着手できる要件を定義します。
本版では、共通Webアプリに加えて Mac ネイティブシェルを前提に固定します。

中核方針は次の4点です。

- CSV設定駆動で手技を実行すること
- 安全上重要な工程で進行ブロックを行うこと
- セッション開始時スナップショットで再現性を守ること
- Web共通 + Macネイティブシェルの責務分割を明確化すること

## 2. ドキュメント構成
1. `01_scope_and_success.md`: スコープ、対象、成功基準
2. `02_operational_flow.md`: 日次運用、同期、運用フロー
3. `03_protocol_csv_v3_spec.md`: CSV v3仕様とMac取り込み
4. `04_domain_model_and_interfaces.md`: ドメインモデル、API I/F、競合制御
5. `05_functional_requirements.md`: 機能要件一覧
6. `06_ui_wireframes_ab.md`: UIワイヤー（A案確定）と遷移
7. `07_acceptance_tests.md`: 受入テスト
8. `08_risks_and_constraints.md`: リスクと制約

設計詳細は `docs/design` 配下を参照します。

## 3. 用語集
- 手技テンプレート: 1回のセッションで実行する一連ステップ定義（CSV取り込み単位）
- セッション: 手技テンプレートを1回実行する実績単位
- 手順スナップショット: セッション開始時点の手技定義を固定保存したもの
- スナップショットハッシュ: 手順スナップショット本文の整合性確認に使う `sha256` 値
- 実行トークン（executionToken）: セッション更新を許可された端末だけが持つ書き込みトークン
- 同期カーソル（syncCursor）: 端末間の遅延同期で差分取得に使う位置情報
- `record_event`: 手動入力モーダルを起動するイベント識別子
- `timer_id`: 自動時刻記録の論理タイマー識別子

## 4. 前提（確定事項）
- 要件書は日本語のみで作成します。
- アプリ利用は本人のみを想定します。
- 利用端末は iPhone と MacBook を想定します。
- 提供形態は共通Web + Macネイティブシェル（WKWebView）です。
- Macはネイティブシェルを主端末として利用します。
- iPhoneは代替端末として、手技確認と記録、履歴閲覧を可能にします。
- 同一セッション中の端末切替は行いません（作成端末のみ更新可能）。
- 同時実行セッションは全端末合計で1件のみです。
- 通信要件はオンライン必須です。
- 記録データ正本はクラウド保存です。
- アプリ内認証は行いません（公開URL運用、受容済みリスク）。
- 医療免責文の常設表示は行いません。
- 異常時導線は警告表示のみ（連絡ボタン等はv1対象外）です。

## 5. 現状ベースライン
現状分析のベースCSV:

- `/Users/sakanet/Downloads/手技マニュアル_ワンバッグ_v2 - 手技マニュアル_v2 (1).csv`

確認済み事実:

- ステップ数: 76
- フェーズ数: 7（事前準備、接続、廃液、注液、切り離し、透析中、終了）
- 状態数: 4（お腹-独立、お腹-接続、お腹→廃液バッグ、お腹←透析液バッグ）

## 6. 意思決定ログ（2026-02-09）
| 項目 | 決定 |
|---|---|
| CSVフォーマット | v3のみ対応 |
| 分岐 | 不可（完全シリアル遷移のみ） |
| 進行制御 | 重要工程と `record_event` でブロック |
| Mac技術 | SwiftUI + WKWebView + UNUserNotificationCenter + IOPM Assertion |
| Web技術 | Next.js + Netlify Functions + Neon PostgreSQL + Drizzle + Netlify Blobs |
| 通知 | MacはOS通知、iPhoneは条件付きOS通知 + アプリ内強調 |
| 画面スリープ対策 | Macネイティブ制御を優先、iPhoneはベストエフォート |
| 同期 | 非リアルタイム単一書き込み（セッション完了後に遅延同期） |
| 認証 | アプリ内認証なし（公開URLのみ） |
| 写真保存 | 上限1GB、超過時に古い順削除 |
| バックアップ | 日次自動バックアップ（保持30日） |
| エクスポート | 手動ZIPエクスポートをv1に含める |
| UIスパイク対象 | ホーム / セッション実行（A案）+ 記録一覧（構成確認） |
| UIコンポーネント基盤 | shadcn/ui を採用 |
| UI標準 | トークン + コンポーネント規約 + 運用チェックリスト |
| ホームスロット | 左から右の実行順序を強制、推奨時刻は厳密昇順で登録 |
| スロット永続化 | `dateLocal` 単位で4スロットを保存、`revision` 競合検知で更新 |
| スロット表示状態 | `未登録` / `未実施` / `実施中` / `実施済み` |
| 予期せぬ離脱 | `active` を保持し、ホームの `実施中` スロットから再開 |
| 明示中断 | セッション画面 `•••` の非常用操作のみ許可。中断後はスロットを `未実施` へ戻す |
| 進行中セッションの別端末閲覧 | v1対象外（完了/中断後のみ別端末閲覧） |
| 日次サマリ必須入力 | 最初完了セッションで血圧/体重/脈拍/体温/出口部状態、最後完了セッションで飲水量/尿量/排便回数 |
| 除水量計算 | 交換#1は未計算、交換#2以降のみ `排液量-前回注液量` を計算 |
| アラーム時刻算出 | `timer_event=end` 到達時刻を `due_at` として通知ジョブを生成（`timer_segment=dwell/drain` のみ対象） |
| アラーム冪等 | `(sessionId, alarmId)` 一意制約で通知重複を防止（再開/再送時に再生成しない） |
| 開始時スナップショット契約 | `POST /sessions` で `sessions` + `session_protocol_snapshots` を原子的に保存。復元時はスナップショットのみ参照し、欠落/改ざんは `SESSION_SNAPSHOT_INTEGRITY_ERROR` |

## 7. 実装者向け注意
- 端末間更新の競合を防ぐため、セッション更新APIは `X-Execution-Token` を必須にします。
- CSVと画像は Mac ローカル取り込みのみ許可し、サーバーに一括アップロードします。
- 写真容量の上限監視と削除処理はサーバー側で必ず自動化します。
- UIスパイクは本番ロジックを変更せず、`/ui-preview/*` 系ルートで完結させます。
